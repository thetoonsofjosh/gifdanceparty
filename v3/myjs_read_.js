var ALL_DANCERS = [
{ name: "alexg", artist: "", category: "irl" },
{ name: "alienhands", artist: "", category: "" },
{ name: "alientwerk", artist: "", category: "" },
{ name: "anxietyonline", artist: "", category: "overlay" },
{ name: "apple", artist: "", category: "" },
{ name: "arnold", artist: "", category: "" },
{ name: "babe", artist: "", category: "" },
{ name: "baldi", artist: "", category: "" },
{ name: "banana", artist: "", category: "" },
{ name: "banana3d", artist: "", category: "" },
{ name: "bananabounce", artist: "", category: "" },
{ name: "banbanstyle", artist: "", category: "" },
{ name: "banginralph", artist: "", category: "irl" },
{ name: "bb", artist: "", category: "" },
{ name: "bearjustin", artist: "", category: "irl" },
{ name: "bearpump", artist: "", category: "" },
{ name: "bernie", artist: "", category: "irl" },
{ name: "bighead", artist: "", category: "" },
{ name: "bird", artist: "", category: "" },
{ name: "bitcarlton", artist: "", category: "" },
{ name: "blob", artist: "", category: "" },
{ name: "bmo", artist: "", category: "" },
{ name: "bodyspin", artist: "", category: "" },
{ name: "bonebreak", artist: "", category: "" },
{ name: "bones", artist: "", category: "" },
{ name: "boomercan", artist: "", category: "irl" },
{ name: "boomersdoink", artist: "", category: "" },
{ name: "brainbeer", artist: "", category: "" },
{ name: "breakglitch", artist: "", category: "" },
{ name: "breakout", artist: "", category: "" },
{ name: "bunnybabe", artist: "", category: "" },
{ name: "bunnyspank", artist: "", category: "" },
{ name: "business", artist: "", category: "" },
{ name: "cact", artist: "", category: "" },
{ name: "cactusgroove", artist: "", category: "" },
{ name: "cat1", artist: "", category: "" },
{ name: "cd", artist: "", category: "overlay" },
{ name: "celery", artist: "", category: "irl" },
{ name: "charizard", artist: "", category: "" },
{ name: "charlie", artist: "", category: "" },
{ name: "chicken", artist: "", category: "" },
{ name: "clapping", artist: "", category: "overlay" },
{ name: "classy", artist: "", category: "irl" },
{ name: "clubpenguin", artist: "", category: "" },
{ name: "cow", artist: "", category: "" },
{ name: "cowboyoof", artist: "", category: "irl" },
{ name: "cowboyspin", artist: "", category: "irl" },
{ name: "crazyarmguy", artist: "", category: "" },
{ name: "crazygreenguy", artist: "", category: "" },
{ name: "crazyhandguy", artist: "", category: "" },
{ name: "crazyliz", artist: "", category: "" },
{ name: "critique", artist: "", category: "overlay" },
{ name: "crochalien", artist: "", category: "irl" },
{ name: "dancegirl", artist: "", category: "" },
{ name: "dannyd", artist: "", category: "irl" },
{ name: "deadpool", artist: "", category: "" },
{ name: "dinochill", artist: "", category: "" },
{ name: "dinohump", artist: "", category: "" },
{ name: "dinoshuffle", artist: "", category: "" },
{ name: "discoball", artist: "", category: "overlay" },
{ name: "doggy", artist: "", category: "" },
{ name: "doggydog", artist: "", category: "" },
{ name: "doggyshuffle", artist: "", category: "irl" },
{ name: "drakeHotline", artist: "", category: "irl" },
{ name: "drakePush", artist: "", category: "irl" },
{ name: "drakeWrist", artist: "", category: "irl" },
{ name: "duck", artist: "", category: "" },
{ name: "ed", artist: "", category: "" },
{ name: "eggman", artist: "", category: "" },
{ name: "elfy", artist: "", category: "" },
{ name: "elvenbooty", artist: "", category: "" },
{ name: "eric", artist: "", category: "" },
{ name: "explosion", artist: "", category: "overlay" },
{ name: "fabio", artist: "", category: "" },
{ name: "fatspidey", artist: "", category: "" },
{ name: "fitness1", artist: "jasonclarke", category: "" },
{ name: "fitnessbooty", artist: "jasonclarke", category: "" },
{ name: "foreveralone", artist: "", category: "" },
{ name: "fred", artist: "", category: "" },
{ name: "freedom", artist: "", category: "" },
{ name: "froggyfresh", artist: "", category: "overlay" },
{ name: "furball", artist: "", category: "" },
{ name: "fuzzball", artist: "", category: "" },
{ name: "fuzzyside", artist: "", category: "" },
{ name: "gblaster", artist: "", category: "overlay" },
{ name: "getdown", artist: "", category: "irl" },
{ name: "gene", artist: "", category: "" },
{ name: "ghosty", artist: "", category: "" },
{ name: "gingerbreadman", artist: "", category: "" },
{ name: "glitchtwist", artist: "", category: "" },
{ name: "gloves", artist: "", category: "irl" },
{ name: "glowstix", artist: "", category: "" },
{ name: "goodra", artist: "", category: "" },
{ name: "gorilla", artist: "", category: "" },
{ name: "greenlady", artist: "", category: "irl" },
{ name: "greenlady2", artist: "", category: "irl" },
{ name: "greenman", artist: "", category: "irl" },
{ name: "greything", artist: "", category: "" },
{ name: "grooveowl", artist: "", category: "" },
{ name: "gummibutt", artist: "", category: "" },
{ name: "gummysuit", artist: "", category: "" },
{ name: "halflife", artist: "", category: "" },
{ name: "headbang", artist: "", category: "" },
{ name: "headphoneguy", artist: "", category: "" },
{ name: "headspin", artist: "", category: "" },
{ name: "heman", artist: "", category: "" },
{ name: "hellicopter", artist: "", category: "" },
{ name: "hipdog", artist: "", category: "" },
{ name: "honeybooboo", artist: "", category: "irl" },
{ name: "hotdog", artist: "", category: "" },
{ name: "hotdogs", artist: "", category: "" },
{ name: "hula", artist: "", category: "" },
{ name: "humpery", artist: "", category: "" },
{ name: "internetparty", artist: "", category: "overlay" },
{ name: "isthisdani", artist: "", category: "irl" },
{ name: "italiandisco", artist: "", category: "" },
{ name: "jankeyguy", artist: "", category: "" },
{ name: "japandoll", artist: "", category: "" },
{ name: "jasonc1", artist: "", category: "irl" },
{ name: "jellyworm", artist: "", category: "" },
{ name: "josereal", artist: "", category: "" },
{ name: "jro", artist: "", category: "irl" },
{ name: "justcarlton", artist: "", category: "irl" },
{ name: "kenny", artist: "", category: "" },
{ name: "kermy", artist: "", category: "" },
{ name: "kirby", artist: "", category: "" },
{ name: "kitty", artist: "", category: "" },
{ name: "kittyhump", artist: "", category: "" },
{ name: "kittytrombone", artist: "", category: "" },
{ name: "konan", artist: "", category: "" },
{ name: "ladytroll", artist: "", category: "" },
{ name: "lemonshoulder", artist: "", category: "" },
{ name: "lilguy", artist: "", category: "" },
{ name: "lisa", artist: "", category: "" },
{ name: "llama", artist: "", category: "" },
{ name: "lshark", artist: "", category: "" },
{ name: "lsquid", artist: "", category: "" },
{ name: "mandarin", artist: "", category: "" },
{ name: "makeitrain", artist: "", category: "" },
{ name: "maranda", artist: "", category: "irl" },
{ name: "matrix", artist: "", category: "" },
{ name: "melissa", artist: "", category: "" },
{ name: "michj", artist: "", category: "" },
{ name: "mienshao", artist: "", category: "" },
{ name: "milk", artist: "", category: "" },
{ name: "mino", artist: "", category: "" },
{ name: "mj", artist: "", category: "" },
{ name: "momdance", artist: "", category: "" },
{ name: "monkeybaby", artist: "", category: "" },
{ name: "mushroom", artist: "", category: "" },
{ name: "ned", artist: "", category: "" },
{ name: "nerd", artist: "", category: "" },
{ name: "nomnom", artist: "", category: "" },
{ name: "noshorts", artist: "", category: "irl" },
{ name: "nyan", artist: "", category: "" },
{ name: "obama", artist: "", category: "" },
{ name: "oldstep", artist: "", category: "" },
{ name: "orangeguy", artist: "", category: "" },
{ name: "orangemike", artist: "", category: "" },
{ name: "orc", artist: "", category: "" },
{ name: "pa", artist: "", category: "irl" },
{ name: "panda", artist: "", category: "" },
{ name: "patrick", artist: "", category: "" },
{ name: "pedopickle", artist: "", category: "" },
{ name: "penguin", artist: "", category: "" },
{ name: "penguin2", artist: "", category: "" },
{ name: "pepego", artist: "", category: "" },
{ name: "peter", artist: "", category: "" },
{ name: "pikachu", artist: "", category: "" },
{ name: "pikachu2", artist: "", category: "" },
{ name: "pilboy", artist: "", category: "" },
{ name: "pixelbabes", artist: "", category: "" },
{ name: "pixelly", artist: "", category: "" },
{ name: "pizza", artist: "", category: "" },
{ name: "pony", artist: "", category: "" },
{ name: "ponyshuffle", artist: "", category: "" },
{ name: "pooh", artist: "", category: "" },
{ name: "popnlock", artist: "", category: "" },
{ name: "porygonz", artist: "", category: "" },
{ name: "possum", artist: "", category: "" },
{ name: "prep", artist: "", category: "irl" },
{ name: "present", artist: "", category: "" },
{ name: "pretzel", artist: "", category: "" },
{ name: "purplecat", artist: "", category: "" },
{ name: "psych", artist: "", category: "" },
{ name: "psycho", artist: "", category: "irl" },
{ name: "psypsy", artist: "", category: "irl" },
{ name: "putin", artist: "", category: "irl" },
{ name: "rainbow", artist: "", category: "overlay" },
{ name: "rainbowwheel", artist: "", category: "overlay" },
{ name: "ralphcan", artist: "", category: "irl" },
{ name: "rambley", artist: "", category: "" },
{ name: "raveon", artist: "", category: "overlay" },
{ name: "ravecat", artist: "", category: "" },
{ name: "ravekitty", artist: "", category: "" },
{ name: "refwalk", artist: "", category: "" },
{ name: "reindeer", artist: "", category: "" },
{ name: "rick", artist: "", category: "" },
{ name: "robothump", artist: "", category: "" },
{ name: "rockkitty", artist: "", category: "" },
{ name: "roger", artist: "", category: "" },
{ name: "runningworm", artist: "", category: "" },
{ name: "sasquatch", artist: "", category: "" },
{ name: "saxguy", artist: "", category: "irl" },
{ name: "scorpion", artist: "", category: "" },
{ name: "scummyb", artist: "", category: "irl" },
{ name: "shaggyandcarl", artist: "", category: "" },
{ name: "shakeitoff", artist: "", category: "irl" },
{ name: "shark", artist: "", category: "" },
{ name: "sharkidiot", artist: "", category: "" },
{ name: "shawty", artist: "", category: "irl" },
{ name: "sheep", artist: "", category: "" },
{ name: "shinchan", artist: "", category: "" },
{ name: "sidereach", artist: "jasonclarke", category: "" },
{ name: "sitonyou", artist: "", category: "irl" },
{ name: "skeletonguy", artist: "", category: "" },
{ name: "skullpump", artist: "", category: "" },
{ name: "slappy", artist: "", category: "irl" },
{ name: "smooch", artist: "", category: "" },
{ name: "snoop", artist: "", category: "irl" },
{ name: "spagett", artist: "", category: "overlay" },
{ name: "speakerhead", artist: "", category: "" },
{ name: "spongeybob", artist: "", category: "" },
{ name: "spinglitch", artist: "", category: "" },
{ name: "squidglamor", artist: "", category: "" },
{ name: "stan", artist: "", category: "" },
{ name: "steve", artist: "", category: "irl" },
{ name: "stitch", artist: "", category: "" },
{ name: "stripper", artist: "", category: "" },
{ name: "stripper1", artist: "", category: "" },
{ name: "stripper2", artist: "", category: "" },
{ name: "stripper3", artist: "", category: "" },
{ name: "stripperinblack", artist: "", category: "" },
{ name: "tej", artist: "", category: "irl" },
{ name: "textbanger", artist: "", category: "overlay" },
{ name: "textfeelmusic", artist: "", category: "overlay" },
{ name: "textparyarrived", artist: "", category: "overlay" },
{ name: "textyougothacked", artist: "", category: "overlay" },
{ name: "thedj", artist: "", category: "overlay" },
{ name: "thehop", artist: "", category: "irl" },
{ name: "thescramble", artist: "", category: "" },
{ name: "thewizard", artist: "", category: "irl" },
{ name: "theworm", artist: "", category: "" },
{ name: "tim", artist: "", category: "irl" },
{ name: "tina", artist: "", category: "" },
{ name: "tripstand", artist: "", category: "" },
{ name: "trippypoly", artist: "", category: "" },
{ name: "troll", artist: "", category: "" },
{ name: "trump", artist: "", category: "irl" },
{ name: "tubeman", artist: "", category: "" },
{ name: "tummy", artist: "", category: "" },
{ name: "twerk", artist: "", category: "irl" },
{ name: "twerk2", artist: "", category: "" },
{ name: "uberhappy", artist: "", category: "" },
{ name: "undeadmale", artist: "", category: "" },
{ name: "unicorn", artist: "", category: "" },
{ name: "veryman", artist: "", category: "" },
{ name: "victorydance", artist: "", category: "irl" },
{ name: "wariopump", artist: "", category: "" },
{ name: "wasntme", artist: "", category: "irl" },
{ name: "wildarms", artist: "", category: "" },
{ name: "waluigipump", artist: "", category: "" },
{ name: "weedguy", artist: "", category: "" },
{ name: "wendy", artist: "", category: "" },
{ name: "whiteguy", artist: "", category: "irl" },
{ name: "whiteperson", artist: "", category: "" },
{ name: "woah", artist: "", category: "" },
{ name: "wormlady", artist: "", category: "" },
{ name: "xray", artist: "", category: "" },
{ name: "yeti", artist: "", category: "" },
{ name: "yoshi", artist: "", category: "" },
{ name: "zombie", artist: "", category: "" },
];

$(document).ready(function(){
	for(var i=0;i<ALL_DANCERS.length;i++){
		if(ALL_DANCERS[i].category==""){
			var img_html = '<img class="img_thumb" id="'+ALL_DANCERS[i].name+'" data-category="'+ALL_DANCERS[i].category+'" src="dancegifs/small/'+ALL_DANCERS[i].name+'_100.gif" height="100">';
			$('#character_dancers').append(img_html);
		}
	}
	$('#character_dancers').append('<div style="clear:both;"></div><div class="full-height"></div>');
	for(var i=0;i<ALL_DANCERS.length;i++){
		if(ALL_DANCERS[i].category=="irl"){
			var img_html = '<img class="img_thumb" id="'+ALL_DANCERS[i].name+'" data-category="'+ALL_DANCERS[i].category+'" src="dancegifs/small/'+ALL_DANCERS[i].name+'_100.gif" height="100">';
			$('#irl_dancers').append(img_html);
		}
	}
	$('#irl_dancers').append('<div style="clear:both;"></div><div class="full-height"></div>');
	for(var i=0;i<ALL_DANCERS.length;i++){
		if(ALL_DANCERS[i].category=="overlay"){
			var img_html = '<img class="img_thumb" id="'+ALL_DANCERS[i].name+'" data-category="'+ALL_DANCERS[i].category+'" src="dancegifs/small/'+ALL_DANCERS[i].name+'_100.gif" height="100">';
			$('#overlays_fx').append(img_html);
		}
	}
	$('#overlays_fx').append('<div style="clear:both;"></div><div class="full-height"></div>');
});


var min_depth = 501;
var max_depth = 505;
var DANCER_COUNT = 0;
var gif_max_width = 600;
var gif_max_height = 800;
var gif_min_width = 120;
var is_dragging = false;
var global_volume = 70;

var ALL_SCENES = [
	{name:"dancefloor_1.jpg"},
	{name:"dancefloor_7b.jpg"},
	{name:"dancefloor_8.jpg"},
	{name:"burnm.jpg"},
	{name:"dancefloor_5.jpg"},
	{name:"dancefloor_6.jpg"},
	{name:"sadroom2.jpg"},
	{name:"dancefloor_9.jpg"},
	{name:"berghain.jpg"},
	{name:"dancefloor_11.jpg"},
	{name:"dancefloor_12.jpg"},
	{name:"dancefloor_13.jpg"},
	{name:"dancefloor_14b.jpg"},
	{name:"dancefloor_10.jpg"},
	{name:"dancefloor_2.jpg"},
	{name:"dancefloor_3.jpg"},
	{name:"dancefloor_4.jpg"},
	{name:"dancefloor_7.jpg"},
	{name:"dancefloor_14.jpg"},
	{name:"dancefloor_15.jpg"},
	{name:"dancefloor_16.jpg"},
	{name:"dancefloor_17.jpg"},
	{name:"disco.jpg"},
];
var SCENE_INDEX = 1;

var ALL_SONGS = [
	{name:"gdp_halffull.mp3"},
	{name:"gdp_nopanties.mp3"},
	{name:"gdp_walkmen.mp3"},
	{name:"gdp_money2.mp3"},
	{name:"gdp_spiltmilk.mp3"},
	{name:"gdp_bubblebutt.mp3"},
	{name:"gdp_nahnah.mp3"},
	{name:"gdp_rex.mp3"},
	{name:"gdp_whitehorse.mp3"},
	{name:"gdp_singalong.mp3"}
];
var SONG_INDEX = 1;
var myGroup; //buzz sounds group
var song_num = 0;













$(document).ready(function(){


	// INIT ___________________________________________________________________________________________
	$("#whiteout").fadeOut(250);
	$("#irl_dancers").hide();
	$("#overlays_fx").hide();
	$("#dancers_container").hide();
	$("#artists_container").hide();
	$("#about_container").hide();
	// Set a default background, which might be overwritten by loadFromURL()
	$("#dancefloor").backstretch("backgrounds/"+ALL_SCENES[SCENE_INDEX].name);
	preload();
	

	$("#firstclick_button").click(function(){
		$("#firstclick_button,#firstclick_text").fadeOut(250);
		setTimeout(()=>{
			buzz.sounds[song_num].play().setVolume(global_volume);
		},500);
		setTimeout(()=>{
			$("#firstclick_container").fadeOut(250);
		},1000);
	});

	// CHANGE SCENE _______________________________________________________________________________________________
	$("#button_scene").click(function(){
		SCENE_INDEX++;
		if(SCENE_INDEX>=ALL_SCENES.length){SCENE_INDEX=0;}
		$("#dancefloor").backstretch("backgrounds/"+ALL_SCENES[SCENE_INDEX].name);
		updateURL(); // ADDED: Update URL on scene change
	});

	// CHANGE SCENE _______________________________________________________________________________________________
	$("#button_music").click(function(){
		song_num++;
		if(song_num>buzz.sounds.length-1){song_num=0;}
		myGroup.stop(); 
		buzz.sounds[song_num].play().setVolume(global_volume);
		updateURL(); // ADDED: Update URL on music change
	});

	// DANCERS _______________________________________________________________________________________________
	$("#button_dancers").click(function(){
		$("#dancers_container").fadeIn(250);
		responsive();
	});
	$("#close_dancers").click(function(){
		$("#dancers_container").fadeOut(250);
		responsive();
	});
	$(".dancerstype").click(function(){
		$(".dancers_type_container").hide();
		$("#dancers_characters,#dancers_irl,#dancers_fx").css("text-decoration","none");
		if($(this).attr("id")==="dancers_characters"){
			$("#character_dancers").fadeIn(250);
			$("#dancers_characters").css("text-decoration","underline");
		}
		if($(this).attr("id")==="dancers_irl"){
			$("#irl_dancers").fadeIn(250);
			$("#dancers_irl").css("text-decoration","underline");
		}
		if($(this).attr("id")==="dancers_fx"){
			$("#overlays_fx").fadeIn(250);
			$("#dancers_fx").css("text-decoration","underline");
		}
	});

	// ADD A DANCER _______________________________________________________________________________________________
	$(document.body).on('click', '.img_thumb' ,function(){
		var name = $(this).attr("id");
		var category = $(this).attr("data-category");
		add_a_dancer(name,category);
		$("#dancers_container").fadeOut(250);
	});

	// MOUSE ENTER/LEAVE DANCER _______________________________________________________________________________________________
	$(document).on('mouseenter','.dance_outter',function(){ 
		if(is_dragging===false){
			$('.dance_outter').css("background-color","rgba(20,20,20,0.0)");
			$('.dance_outter').css("border","none");
			$('.dance_outter').children("div:not(:first-child)").hide();
			$('.dance_outter').find(".ui-resizable-handle").hide();
			$('.dance_outter').find(".ui-resizable-se").hide();
			$(this).css("background-color","rgba(20,20,20,0.25)");
			$(this).css({"border-width":"1px","border-style":"dashed","border-color":"#ccc"});
			$(this).children("div:not(:first-child)").show();
			$(this).find(".ui-resizable-handle").show();
			$(this).find(".ui-resizable-se").show();
		}
	});
	$(document).on('mouseleave','.dance_outter',function(){ 
		if(is_dragging===false){
			$(this).css("background-color","rgba(20,20,20,0.0)");
			$(this).css("border","none");
			$(this).children("div:not(:first-child)").hide();
			$(this).find(".ui-resizable-handle").hide();
			$(this).find(".ui-resizable-se").hide();
			$(this).find(".dancer_shadow").show();
		}
	});

	// REMOVE DANCER _______________________________________________________________________________________________
	$(document).on('click','.close_dancer',function(){
		var uid = $(this).closest(".dance_outter").attr("id");
		$("#"+uid).remove();
		updateURL(); // ADDED: Update URL on remove
	});

	// FRONT/BACK DANCER _______________________________________________________________________________________________
	$(document).on('click','.bfront',function(){
		var uid = $(this).closest(".dance_outter").attr("id");
		max_depth++;
		$("#"+uid).css("z-index",max_depth);
		updateURL(); // ADDED: Update URL on z-index change
	});
	$(document).on('click','.bback',function(){
		var uid = $(this).closest(".dance_outter").attr("id");
		min_depth--;
		$("#"+uid).css("z-index",min_depth);
		updateURL(); // ADDED: Update URL on z-index change
	});

	// CLONE DANCER _______________________________________________________________________________________________
	$(document).on('click','.clone_dancer',function(){
		var x = parseInt($(this).closest(".dance_outter").css("left"));
		var y = parseInt($(this).closest(".dance_outter").css("top"));
		var z = parseInt($(this).closest(".dance_outter").css("z-index"));
		var w = parseInt($(this).closest(".dance_outter").css("width"));
		console.log(x+","+y+","+z+","+w);
		var uid = $(this).attr("id");
		var name = $(this).attr("data-name");
		var category = $(this).attr("data-category");
		add_a_dancer(name,category,x,y,z,w);
	});

	// FLIP DANCER _______________________________________________________________________________________________
	$(document).on('click','.hflip',function(){
		var uid = $(this).closest(".dance_outter").attr("id");
	    var flip_element = $("#"+uid).find(".dancer");
	    if(flip_element.attr("data-flip")==="false"){
	      flip_element.addClass("flip-h");
	      flip_element.attr("data-flip","true");
	    }else{
	      flip_element.removeClass("flip-h");
	      flip_element.attr("data-flip","false");
	    }
		updateURL(); // ADDED: Update URL on flip
	});

	// ABOUT _______________________________________________________________________________________________
	$("#button_about").click(function(){
		$("#about_container").fadeIn(250);
		responsive();
	});
	$("#close_about").click(function(){
		$("#about_container").fadeOut(250);
		responsive();
	});

	// ARTISTS _______________________________________________________________________________________________
	$("#button_artists").click(function(){
		$("#artists_container").fadeIn(250);
		responsive();
	});
	$("#close_artists").click(function(){
		$("#artists_container").fadeOut(250);
		responsive();
	});

});


//________________________________________________________ INIT DEFAULT DANCEFLOOR
function init_default(){ 
	var bw = parseInt($("body").width());
	var bh = parseInt($("body").height());
	add_a_dancer("makeitrain","", 0.41*bw, 0.41*bh, 501, 0.18*bw, true);
	add_a_dancer("ned","", 0.08*bw, 0.45*bh, 503, 0.29*bw, true);
	add_a_dancer("baldi","", 0.67*bw, 0.41*bh, 504, 0.26*bw, true);
	max_depth = 505;
	updateURL(); // Create a shareable URL for the default scene
}

//___________________________________________________________________________________ ADD A DANCER
function add_a_dancer(name,category,_x,_y,_z,_w,preload){

	if(_x===undefined||_x===null){
		var x = 100;
		var y = 100;
		max_depth++;
		var z = max_depth;
		var uid = name+makeid();
		var w = 250;
	}else if(preload===true){
		var x = _x;
		var y = _y;
		var z = _z;
		var w = _w;
		var uid = name+makeid();
	}else{ //on clone we pass vals
		var x = _x - _w - (20*Math.random());
		if(x<0){x=10;}
		var y = _y;
		var z = _z + 1;
		var uid = name+makeid();
		var w = _w;
	}

	$("#dancefloor").append("<div class='dance_outter' id='"+uid+"' data-name='"+name+"' style='z-index:"+z+";top:"+y+"px;left:"+x+"px;width:auto;height:auto;'>"+
							   "<div class='resizer' style='width:"+w+"px;height:auto;'>"+
							     "<img class='dancer' data-flip='false' src='dancegifs/original/"+name+".gif' width='100%'>"+
							   "</div>"+
							   "<img class='shadow' src='img/dancer_shadow.png' width='100%'>"+
							   "<div class='hflip dfont'>FLIP</div>"+
							   "<div class='bfront dfont'>FRONT</div>"+
							   "<div class='bback dfont'>BACK</div>"+
							   "<div class='resize_help dfont2'>RESIZE</div>"+
							   "<div class='close_dancer dfont'>X</div>"+
							   "<div class='clone_dancer dfont' id='"+uid+"' data-name='"+name+"'>CLONE</div>"+
							 "</div>");

	all_resizable();
	all_draggable();

	$("#"+uid).find(".ui-resizable-handle").hide();
	$("#"+uid).find(".ui-resizable-se").hide();
	$("#"+uid).children("div:not(:first-child)").hide();
	$("#"+uid).find(".dancer_shadow").show();
	if(category==="overlay"){
		$("#"+uid).find(".shadow").remove(); //no shadow for overlay
	}

	DANCER_COUNT++;
    // Only update URL if it's not part of the initial scene load
    if(preload !== true){
        updateURL();
    }
}


//___________________________________________________________________________________ RESIZABLE
function all_resizable(){ 
	$(".resizer").resizable({
		aspectRatio: true,
		minWidth: 120,
		maxWidth: gif_max_width,
		maxHeight: gif_max_height,
		resize:function(event,ui){
			$(this).parent().css("width",ui.size.width+"px").css("height",ui.size.height+"px");
		},
		stop:function(event,ui){
			updateURL(); // ADDED: Update URL on resize stop
		}
	});
}

//___________________________________________________________________________________ DRAGGABLE
function all_draggable(){ 
	$(".dance_outter").draggable({
		scroll: false,
		start:function(){
			is_dragging = true;
		},
		drag: function(event,ui){ 
            // no need to update on drag, it's too intensive
		},
		stop:function(event,ui){
            is_dragging = false;
			updateURL(); // ADDED: Update URL on drag stop
		}
	});
}

//___________________________________________________________________________________ PRELOAD
function preload(){ 

	var loader = new PxLoader(); 
	for(var i=0;i<ALL_SCENES.length;i++){
		// Use the correct path for preloading
		loader.addImage("backgrounds/"+ALL_SCENES[i].name);	
	}
	loader.addCompletionListener(function() { 
	    done_preload();
	}); 
	loader.start(); 

	buzz.defaults.loop = true;
	buzz.defaults.formats = ['mp3'];
	buzz.defaults.preload = 'auto';
	buzz.defaults.autoplay = false;
	var spiltmilk = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/spilt_milk_neighbor_128"); spiltmilk.set("id","spiltmilk");
	var money = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/gdp_money2"); money.set("id","money");
	var bubblebutt = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/gdp_bubblebutt"); bubblebutt.set("id","bubblebutt");
	var twist = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/twist"); twist.set("id","twist");
	var wegotyou = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/wegotyou"); wegotyou.set("id","wegotyou");
	var nahnah = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/gdp_nahnah"); nahnah.set("id","nahnah");
	var sandstorm = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/sandstorm"); sandstorm.set("id","sandstorm");
	var Taylor_shake_it_off = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/Taylor_shake_it_off"); Taylor_shake_it_off.set("id","Taylor_shake_it_off");
	var heman = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/heman"); heman.set("id","heman");
	var oakenfold = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/oakenfold"); oakenfold.set("id","oakenfold");
	var grounded = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/grounded"); grounded.set("id","grounded");
	var singalong = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/gdp_singalong"); singalong.set("id","singalong");
	var trololo = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/trololo"); trololo.set("id","trololo");
	var breadfish = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/breadfish"); breadfish.set("id","breadfish");
	var rex = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/rex_the_dog_128"); rex.set("id","rex");
	var whitehorse = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/gdp_whitehorse"); whitehorse.set("id", "whitehorse");
	var halffull = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/gdp_halffull"); halffull.set("id","halffull");
	var nopanties = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/gdp_nopanties"); nopanties.set("id","nopanties");
	var walkmen = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/gdp_walkmen"); walkmen.set("id","walkmen");
	var bazz = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/bazz"); bazz.set("id","bazz");
	var fatboy = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/fatboy"); fatboy.set("id","fatboy");
	var rex2 = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/gdp_rex"); rex2.set("id","rex2");
	var spiltmilk2 = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/gdp_spiltmilk"); spiltmilk2.set("id","spiltmilk2");
	var hotlineloop = new buzz.sound("https://thetoonsofjosh.github.io/gifdanceparty/v3/music/hotlineloop"); hotlineloop.set("id","hotlineloop");
	myGroup = new buzz.group([rex,money,walkmen,whitehorse,spiltmilk,spiltmilk2,rex2,bazz,breadfish,singalong,fatboy,grounded,trololo,sandstorm,nopanties,halffull,heman,wegotyou,bubblebutt,hotlineloop,twist,Taylor_shake_it_off,oakenfold,nahnah]); 

	myGroup.setVolume(global_volume);
}

// MODIFIED: This function now checks for a shared URL first
function done_preload(){
	console.log("preload complete");
    // Try to load from URL first. If it returns false (no hash), load the default.
    if (!loadFromURL()) {
	    init_default();
    }
	setTimeout(()=>{
		$("#loading_container").fadeOut(250);
	},1000); // Shortened delay
}


//___________________________________________________________________________________ NEW - URL SHARING FUNCTIONS

/**
 * Gathers all scene data, encodes it, and updates the window's URL hash.
 */
function updateURL() {
    var sceneData = {
        d: [], // Dancers
        s: SCENE_INDEX, // Scene
        m: song_num // Music
    };

    $(".dance_outter").each(function() {
        var dancerEl = $(this);
        var resizerEl = dancerEl.find(".resizer");
        var dancerImg = dancerEl.find(".dancer");

        var dancer = {
            n: dancerEl.attr("data-name"),
            // Store positions and width as percentages for better responsiveness
            x: parseFloat(dancerEl.css("left")) / $("body").width(),
            y: parseFloat(dancerEl.css("top")) / $("body").height(),
            w: parseFloat(resizerEl.css("width")) / $("body").width(),
            z: parseInt(dancerEl.css("z-index")),
            f: dancerImg.attr("data-flip") === "true" ? 1 : 0 // 1 for flipped, 0 for normal
        };
        sceneData.d.push(dancer);
    });

    // btoa() creates a Base64-encoded string from a string.
    var encodedData = btoa(JSON.stringify(sceneData));
    window.location.hash = encodedData;
}


/**
 * Reads data from URL hash, decodes it, and builds the scene.
 * @returns {boolean} - True if a scene was loaded from URL, false otherwise.
 */
function loadFromURL() {
    // Check if there is a hash and it's not empty
    if (!window.location.hash || window.location.hash.length < 2) return false;

    try {
        var encodedData = window.location.hash.substring(1);
        // atob() decodes a Base64-encoded string.
        var decodedData = atob(encodedData);
        var sceneData = JSON.parse(decodedData);

        // Clear the dancefloor before adding new elements
        $("#dancefloor").empty();

        var maxZ = 0;
        if (sceneData.d && Array.isArray(sceneData.d)) {
            sceneData.d.forEach(function(dancer) {
                var bodyWidth = $("body").width();
                var bodyHeight = $("body").height();
                // Convert percentage-based positions back to pixels
                var x_pos = dancer.x * bodyWidth;
                var y_pos = dancer.y * bodyHeight;
                var width = dancer.w * bodyWidth;
                
                var dancerInfo = ALL_DANCERS.find(d => d.name === dancer.n);
                var category = dancerInfo ? dancerInfo.category : "";

                add_a_dancer(dancer.n, category, x_pos, y_pos, dancer.z, width, true);
                
                // Find the dancer element we just added to set its flip state
                var addedDancerEl = $(".dance_outter").last();
                if (dancer.f === 1) {
                    var flip_element = addedDancerEl.find(".dancer");
                    flip_element.addClass("flip-h");
                    flip_element.attr("data-flip","true");
                }

                // Track the highest z-index to set the global max_depth correctly
                if(dancer.z > maxZ) {
                    maxZ = dancer.z;
                }
            });
        }
        max_depth = maxZ > 0 ? maxZ + 1 : 505;

        // Load Scene
        SCENE_INDEX = sceneData.s || 0;
		if(SCENE_INDEX >= ALL_SCENES.length){ SCENE_INDEX = 0; } // Safety check
		$("#dancefloor").backstretch("backgrounds/"+ALL_SCENES[SCENE_INDEX].name);

        // Load Music
        song_num = sceneData.m || 0;
        if(song_num > buzz.sounds.length-1){ song_num = 0; } // Safety check

        return true; // Successfully loaded from URL

    } catch (e) {
        console.error("Failed to load scene from URL:", e);
        // Clear the invalid hash to prevent future errors
        window.location.hash = "";
        return false; // Failed to load
    }
}


//___________________________________________________________________________________ OTHER FUNCTIONS
function makeid(){
  var text = "";
  var possible = "abcdefghijklmnopqrstuvwxyz";
  for (var i = 0; i < 8; i++)
    text += possible.charAt(Math.floor(Math.random() * possible.length));
  return text;
}


//___________________________________________________________________________________ RESPONSIVENESS
function responsive(){
	$(".centerxy").each(function(){ $(this).center(1,1); });
	$(".centerx").each(function(){ $(this).center(1,0); });
	$(".centery").each(function(){ $(this).center(0,1); });
}
$(window).load(function(){
	responsive()
});
$(document).ready(function(){
	responsive()
});
$(window).resize(function(){
	responsive()
    // OPTIONAL: Could call updateURL() here if you want positions to be perfect after a resize,
    // but it might create too many history entries. Dragging an item after resize will fix it.
});
$.fn.center = function(x,y){
	if(x==1){this.css("left", Math.max(0, (($(this).parent().width() - $(this).outerWidth()) / 2) ) + "px");}
	if(y==1){this.css("top", Math.max(0, (($(this).parent().height() - $(this).outerHeight()) / 2) ) + "px");}
	return this;
};

document.addEventListener('contextmenu', event => event.preventDefault());
